<!DOCTYPE chapter>
<chapter xmlns="http://docbook.org/ns/docbook" version="5.0" xml:id="session" xml:lang="ru">
    <info>
        <title>Сессионное окружение</title>
    </info>

    <para>В этой главе описываются операторы управления сессионным окружением. Данные SQL операторы
        работают вне механизма управления транзакциями, изменения выполенные ими вступаю в силу
        немедленно.</para>

    <para>Операторы управления сессионным окруженияем доступны в том числе и в PSQL коде. Это
        особенно полезно в ON CONNECT триггерах.</para>

    <para>Операторы управления сессионным окружением разбиты на следующие группы: <itemizedlist>
            <listitem>
                <para>управления тайм-аутами;</para>
            </listitem>
            <listitem>
                <para>управление пулом внешних соединений;</para>
            </listitem>
            <listitem>
                <para>изменение текущей роли;</para>
            </listitem>
            <listitem>
                <para>управление обработкой типа DECFLOAT;</para>
            </listitem>
            <listitem>
                <para>управление часовым поясом;</para>
            </listitem>
            <listitem>
                <para>сброс сессионного окружения.</para>
            </listitem>
        </itemizedlist></para>

    <section xml:id="session-timeout">
        <info>
            <title>Тайм-ауты</title>
        </info>

        <para>В Firebird существует два вида тайм-аута:<itemizedlist>
                <listitem>
                    <para>тайм-аут простоя соединения;</para>
                </listitem>
                <listitem>
                    <para>тайм-аут выполнения SQL оператора.</para>
                </listitem>
            </itemizedlist></para>

        <section xml:id="session-timeout-statemen">
            <title>Тайм-аут выполнения SQL оператора</title>

            <para>Данная функциональность позволяет автоматически прекратить выполнение SQL
                оператора если он выполняется дольше заданного значения тайм-аута.</para>

            <para>Данная функция может быть полезна для:<itemizedlist>
                    <listitem>
                        <para>Администраторов баз данных, которые получают инструмент для
                            ограничения времени выполнения тяжёлых запросов, которые потребляют
                            много ресурсов;</para>
                    </listitem>
                    <listitem>
                        <para>Разработчиков приложений, которые могут использовать тайм-ауты SQL
                            операторов при написании и отладке сложных запросов с заранее
                            неизвестным временем выполнения;</para>
                    </listitem>
                    <listitem>
                        <para>Тестеров, которые могут использовать тайм-ауты SQL операторов для
                            обнаружения долго выполняющихся запросов и обеспечения конечного времени
                            выполнения набора тестов. </para>
                    </listitem>
                </itemizedlist></para>

            <para>Эта функциональность работает следующим образом. Когда начинается выполнение
                оператора (или открывается курсор) Firebird запускает специальный таймер. Выборка
                записей (fetch) не сбрасывает таймер. Таймер останавливается если выполнение SQL
                оператора закончено или извлечена (fetch) последняя запись.</para>
            <para>По истечению тайм-аута:<itemizedlist>
                    <listitem>
                        <para>Если выполнение SQL оператора активно, оно останавливается в заданный
                            момент.</para>
                    </listitem>
                    <listitem>
                        <para>Если SQL оператор не активен в данный момент (например между выборками
                            (fetch)), то он будет помечен как отменённый, следующая выборка (fetch)
                            прервёт выполнение и будет возвращена ошибка.</para>
                    </listitem>
                </itemizedlist></para>

            <para>Значение тайм-аута может быть установлено:<itemizedlist>
                    <listitem>
                        <para>На уровне базы данных. Значение параметра
                                <parameter>StatementTimeout</parameter> может быть установлено в
                                <filename>firebird.conf</filename> (или
                                <filename>databases.conf</filename>) администратором базы данных.
                            Область действия все операторы во всех соединениях. Параметр
                                <parameter>StatementTimeout</parameter> устанавливает тайм-аут в
                            секундах, по истечении которого выполнение SQL операторов будет
                            отменено. Ноль означает, что тайм-аут не установлен. Значение по
                            умолчанию равно 0.</para>
                    </listitem>
                    <listitem>
                        <para>На уровне соединения. Может быть установлен с использованием API (в
                            миллисекундах) или с помощью SQL оператора <link
                                linkend="session-timeout-set_statement_timeout">SET STATEMENT
                                TIMEOUT</link>. Область действия текущее подключение.</para>
                    </listitem>
                    <listitem>
                        <para>На уровне оператора. Может быть установлен с использованием API (в
                            миллисекундах). Область действия текущий SQL оператор.</para>
                    </listitem>
                </itemizedlist></para>

            <para>Эффективное значение тайм-аута SQL оператора вычисляется каждый раз, когда
                запускается SQL оператор (открывается курсор), следующим образом:<itemizedlist>
                    <listitem>
                        <para>если тайм-аут не установлен на уровне оператора, будет использовано
                            значение тайм-аута уровня соединения;</para>
                    </listitem>
                    <listitem>
                        <para>если тайм-аут не установлен на уровне соединения, будет использовано
                            значение тайм-аута уровня базы данных;</para>
                    </listitem>
                    <listitem>
                        <para>значение тайм-аута не может быть больше, чем значение установленное на
                            уровне базы данных. Таким образом, значение тайм-аута может
                            перекрываться разработчиком приложения в более низких областях, но оно
                            не может выти за пределы установленные DBA в конфигурации.</para>
                    </listitem>
                </itemizedlist></para>

            <para>Нулевой тайм-аут не обозначает отсутствие тайм-аута, просто в этом случае таймер
                выполнения оператора не запускается.</para>

            <para>Несмотря на то, что тайм-аут выполнения SQL оператора может быть установлен в
                миллисекундах, абсолютная точность не гарантируется. При высокой нагрузке он может
                быть менее точным. Единственная гарантия которую может дать Firebird это то, что
                тайм-аут не сработает раньше указанного момента. Клиентское приложение может ждать
                больше времени, чем установленное значение тайм-аута если движку Firebird необходимо
                отменить множество действий связанных с отменой оператора.</para>

            <para>Тайм-аут выполнения оператора игнорируется для всех внутренних запросов, которые
                используется движком Firebird. Кроме того, тайм-аут игнорируется для DDL
                операторов.</para>

            <section xml:id="session-timeout-set_statement_timeout">
                <info>
                    <title>SET STATEMENT TIMEOUT</title>
                    <keywordset>
                        <keyword>SET STATEMENT TIMEOUT</keyword>
                    </keywordset>
                </info>
                <indexterm><primary>SET STATEMENT TIMEOUT</primary></indexterm>

                <formalpara>
                    <title>Назначение:</title>

                    <para>Установка тайм-аута выполнения SQL операторов на уровне соединения.</para>
                </formalpara>

                <formalpara>
                    <title>Доступно в:</title>

                    <para>DSQL.</para>
                </formalpara>

                <formalpara>
                    <title>Синтаксис:</title>

                    <para><literallayout class="monospaced">                                       
SET STATEMENT TIMEOUT <replaceable>value</replaceable> [HOUR | MINUTE | SECOND | MILLISECOND]       
            </literallayout></para>
                </formalpara>

                <para>
                    <table frame="all">
                        <?dbfo keep-together='auto'?>
                        <title>Параметры оператора SET STATEMENT TIMEOUT</title>
                        <tgroup cols="2">
                            <colspec colname="c1" colnum="1" colwidth="1.2*" align="left"/>
                            <colspec colname="c2" colnum="2" colwidth="2.8*" align="justify"/>
                            <thead>
                                <row>
                                    <entry align="center">Параметр</entry>
                                    <entry align="center">Описание</entry>
                                </row>
                            </thead>
                            <tbody>
                                <row>
                                    <entry><replaceable>value</replaceable></entry>
                                    <entry>
                                        <para>Значение тайм-аута выполнения SQL операторов в
                                            указанных единицах измерения времени. Если единица
                                            измерения времени не указано, то по умолчанию значение
                                            тайм-аута измеряется в секундах.</para>
                                    </entry>
                                </row>
                            </tbody>
                        </tgroup>
                    </table>
                </para>

                <para>Устанавливает значение тайм-аута выполнения SQL операторов на уровне текущего
                    соединения. Если единица времени не указана, то по умолчанию тайм-аут будет
                    учитываться в секундах.</para>

                <note>
                    <para>Данный SQL оператор работает вне механизма управления транзакциями и
                        вступают в силу немедленно.</para>
                </note>

                <formalpara>
                    <title>Примеры:</title>
                    <para>
                        <informalexample>
                            <para><programlisting language="sql">
SET STATEMENT TIMEOUT 2 MINUTE            
            </programlisting></para>
                        </informalexample>
                    </para>
                </formalpara>

                <note>
                    <para>Интерактивный инструмент <application>isql</application> дополнительно
                        поддерживает команду:
                        <literallayout class="monospaced">
SET LOCAL_TIMEOUT <replaceable>int</replaceable>
            </literallayout>
                    </para>
                    <para>Эта команда позволяет установить тайм-аут выполнения оператора (в
                        миллисекундах) для следующего оператора. После выполнения SQL оператора он
                        автоматически сбрасывается в ноль. </para>
                </note>
            </section>

        </section>

        <section xml:id="session-timeout-idle_session">
            <title>Тайм-аут простоя соединения</title>

            <para>Данная функциональность позволяет автоматически закрывать пользовательские
                подключения после периода бездействия. Она может быть использована администраторами
                баз данных, чтобы принудительно закрывать старые неактивные соединения и освобождать
                связанные с ними ресурсы. Приложения и инструменты разработчика могут использовать
                её как замену самодельного контроля за временем жизни подключения.</para>

            <para>Рекомендуется (но не обязательно) устанавливать тай-аут простоя в разумное большое
                значение, например, несколько часов. По умолчанию эта функция отключена.</para>

            <para>Эта функциональность работает следующим образом. Когда пользовательский вызов API
                покидает движок, запускается специальный таймер связанный с текущим подключением.
                Как только пользовательский вызов входит в движок, таймер ожидания останавливается.
                Если тайм-аут простоя истечёт движок закроет соединение так как будто произошло
                асинхронная отмена подключения:<itemizedlist>
                    <listitem>
                        <para>все активные операторы и курсоры закрываются;</para>
                    </listitem>
                    <listitem>
                        <para>все активные транзакции откатываются;</para>
                    </listitem>
                    <listitem>
                        <para>сетевые соединения не закрываются в данный момент. Это позволяет
                            клиентскому приложение получить точный код ошибки при следующем вызове
                            API. Сетевое соединение будет закрыто на стороне сервера после того, как
                            ошибка сообщена, или если клиентская сторона отключится по истечению
                            тайм-аута сети.</para>
                    </listitem>
                </itemizedlist></para>

            <para>Тайм-аут простоя соединения может быть установлен: <itemizedlist>
                    <listitem>
                        <para>На уровне базы данных. Значение параметра
                                <parameter>ConnectionIdleTimeout</parameter> может быть установлено
                            в <filename>firebird.conf</filename> (или
                                <filename>databases.conf</filename>) администратором базы данных.
                            Область действия все пользовательские подключения, исключая системные
                            подключения (garbage collector, cache writer, и др.). Параметр
                                <parameter>ConnectionIdleTimeout</parameter> устанавливает тайм-аут
                            в минутах, по истечении которого неактивное соединение будет разорвано
                            движком. Ноль означает, что тайм-аут не установлен. Значение по
                            умолчанию равно 0.</para>
                    </listitem>
                    <listitem>
                        <para>На уровне подключения. Может быть установлен с использованием API (в
                            секундах) или с помощью SQL оператора <link
                                linkend="session-timeout-set_session_idle_timeout">SET SESSION IDLE
                                TIMEOUT</link>. Область действия все операторы в текущем
                            подключении.</para>
                    </listitem>
                </itemizedlist></para>

            <para>Эффективное значение тайм-аута простоя вычисляется каждый раз, когда
                пользовательский вызов API покидает движок, следующим образом:<itemizedlist>
                    <listitem>
                        <para>если тайм-аут не установлен на уровне подключения, будет использовано
                            значение уровня базы данных;</para>
                    </listitem>
                    <listitem>
                        <para>значение тайм-аута не может быть больше, чем значение установленное на
                            уровне базы данных. Таким образом, значение тайм-аута простоя может
                            перекрываться разработчиком приложения для заданного подключения, но оно
                            не может выти за пределы установленные DBA в конфигурации.</para>
                    </listitem>
                </itemizedlist></para>

            <para>Нулевой тайм-аут не обозначает отсутствие тайм-аута, просто в этом случае таймер
                ожидания не запускается.</para>

            <para>Несмотря на то, что тайм-аут простоя может быть установлен в секундах, абсолютная
                точность не гарантируется. При высокой нагрузке он может быть менее точным.
                Единственная гарантия которую может дать Firebird это то, что тайм-аут не сработает
                раньше указанного момента.</para>

            <section xml:id="session-timeout-set_session_idle_timeout">
                <info>
                    <title>SET SESSION IDLE TIMEOUT</title>
                    <keywordset>
                        <keyword>SET SESSION IDLE TIMEOUT</keyword>
                    </keywordset>
                </info>
                <indexterm><primary>SET SESSION IDLE TIMEOUT</primary></indexterm>

                <formalpara>
                    <title>Назначение:</title>

                    <para>Установка тайм-аута простоя соединения на уровне соединения.</para>
                </formalpara>

                <formalpara>
                    <title>Доступно в:</title>

                    <para>DSQL.</para>
                </formalpara>

                <formalpara>
                    <title>Синтаксис:</title>

                    <para><literallayout class="monospaced">                                       
SET SESSION IDLE TIMEOUT <replaceable>value</replaceable> [HOUR | MINUTE | SECOND]       
            </literallayout></para>
                </formalpara>

                <para>
                    <table frame="all">
                        <?dbfo keep-together='auto'?>
                        <title>Параметры оператора SET SESSION IDLE TIMEOUT</title>
                        <tgroup cols="2">
                            <colspec colname="c1" colnum="1" colwidth="1.2*" align="left"/>
                            <colspec colname="c2" colnum="2" colwidth="2.8*" align="justify"/>
                            <thead>
                                <row>
                                    <entry align="center">Параметр</entry>
                                    <entry align="center">Описание</entry>
                                </row>
                            </thead>
                            <tbody>
                                <row>
                                    <entry><replaceable>value</replaceable></entry>
                                    <entry>
                                        <para>Значение тайм-аута простоя в указанных единицах
                                            измерения времени. Если единица измерения времени не
                                            указано, то по умолчанию значение тайм-аута измеряется в
                                            минутах.</para>
                                    </entry>
                                </row>
                            </tbody>
                        </tgroup>
                    </table>
                </para>

                <para>Устанавливает значение тайм-аута простоя на уровне текущего соединения. Если
                    единица времени не указана, то по умолчанию тайм-аут будет учитываться в
                    минутах.</para>

                <note>
                    <para>Данный SQL оператор работает вне механизма управления транзакциями и
                        вступают в силу немедленно.</para>
                </note>

                <formalpara>
                    <title>Примеры:</title>
                    <para>
                        <informalexample>
                            <para><programlisting language="sql">
SET SESSION IDLE TIMEOUT 8 HOUR            
            </programlisting></para>
                        </informalexample>
                    </para>
                </formalpara>
            </section>

        </section>
    </section>


    <section xml:id="session-extconnpool">
        <info>
            <title>Пул внешних соединений</title>
            <keywordset>
                <keyword>ALTER EXTERNAL CONNECTIONS POOL</keyword>
            </keywordset>
        </info>

        <indexterm><primary>ALTER EXTERNAL CONNECTIONS POOL</primary></indexterm>

        <para>Каждое внешнее соединение (созданное оператором EXECUTE STATEMENT ... ON EXTERNAL) при
            создании связывается с пулом соединений (подробнее см. <link
                linkend="psql-statements-execstmt-ext-connpool">Пул внешних подключений</link>).
            Данная группа операторов позволяет управлять пулом внешних соединений. При его
            подготовке они описываются как DDL операторы, но имеют немедленный эффект: то есть они
            выполняются немедленно и полностью, не дожидаясь фиксации транзакции. Изменения
            применяются к экземляру пула в памяти в текущем процессе Firebird. Поэтому изменение в
            одном классическом процессе не влияет на другие классические процессы. Изменения не
            являются постоянными и после перезапуска Firebird будет использовать настройки пула из
                <filename>firebird.conf</filename>.</para>

        <para>Для выполенения операторов данной группы требуется системная привилегия
            MODIFY_EXT_CONN_POOL. Подробнее о системных привелегиях см. <link
                linkend="security-roles-create">CREATE ROLE</link>.</para>

        <section xml:id="session-extconnpool-setsize">
            <info>
                <title>ALTER EXTERNAL CONNECTIONS POOL SET SIZE</title>
            </info>

            <indexterm>
                <primary>ALTER EXTERNAL CONNECTIONS POOL</primary>
                <secondary>SET SIZE</secondary>
            </indexterm>

            <formalpara>
                <title>Назначение:</title>

                <para>Устанавливает максимальное количество бездействующих соединений.</para>
            </formalpara>

            <formalpara>
                <title>Синтаксис:</title>

                <para>
                    <literallayout class="monospaced">
ALTER EXTERNAL CONNECTIONS POOL SET SIZE <replaceable>&lt;size&gt;</replaceable>                        
                        </literallayout>
                </para>
            </formalpara>

            <para>
                <table frame="all">
                    <?dbfo keep-together='auto'?>
                    <title>Параметры оператора ALTER EXTERNAL CONNECTIONS POOL SET SIZE</title>
                    <tgroup cols="2">
                        <colspec colname="c1" colnum="1" colwidth="1.2*" align="left"/>
                        <colspec colname="c2" colnum="2" colwidth="2.8*" align="justify"/>
                        <thead>
                            <row>
                                <entry align="center">Параметр</entry>
                                <entry align="center">Описание</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry><replaceable>size</replaceable></entry>
                                <entry>
                                    <para>Размер пула внешних соединений. Допустимые значения от 0
                                        до 1000.</para>
                                </entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </para>

            <para>Оператор <code>ALTER EXTERNAL CONNECTIONS POOL SET SIZE</code> устанавливает
                максимальное количество бездействующих соединений в пуле внешних соединений.
                Допустимые значения от 0 до 1000. Нулевое значение обозначает что пул выключен.
                Значение по умолчанию оперделяется в <filename>firebird.conf</filename> (параметр
                ExtConnPoolSize).</para>

        </section>

        <section xml:id="session-extconnpool-setlifetime">
            <info>
                <title>ALTER EXTERNAL CONNECTIONS POOL SET LIFETIME</title>
            </info>

            <indexterm>
                <primary>ALTER EXTERNAL CONNECTIONS POOL</primary>
                <secondary>SET LIFETIME</secondary>
            </indexterm>

            <formalpara>
                <title>Назначение:</title>

                <para>Устанавливает время жизни бездействующих соединений.</para>
            </formalpara>

            <formalpara>
                <title>Синтаксис:</title>

                <para>
                    <literallayout class="monospaced">
ALTER EXTERNAL CONNECTIONS POOL SET LIFETIME <replaceable>&lt;value&gt;</replaceable> <replaceable>&lt;time_part&gt;</replaceable>
                        
<replaceable>&lt;time_part&gt;</replaceable> ::= SECOND | MINUTE | HOUR                       
                        </literallayout>
                </para>
            </formalpara>

            <para>
                <table frame="all">
                    <?dbfo keep-together='auto'?>
                    <title>Параметры оператора ALTER EXTERNAL CONNECTIONS POOL SET LIFETIME</title>
                    <tgroup cols="2">
                        <colspec colname="c1" colnum="1" colwidth="1.2*" align="left"/>
                        <colspec colname="c2" colnum="2" colwidth="2.8*" align="justify"/>
                        <thead>
                            <row>
                                <entry align="center">Параметр</entry>
                                <entry align="center">Описание</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry><replaceable>value</replaceable></entry>
                                <entry>
                                    <para>Время жизни бездействующих соединений.</para>
                                </entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </para>

            <para>Оператор <code>ALTER EXTERNAL CONNECTIONS POOL SET LIFETIME</code> устанавливает
                время жизни бездействующих соединений в пуле внешних соединений. Допустимые значения
                от 1 секуды до 24 часов. Значение по умолчанию оперделяется в
                    <filename>firebird.conf</filename> (параметр ExtConnPoolLifeTime в
                секундах).</para>

        </section>

        <section xml:id="session-extconnpool-clearall">
            <info>
                <title>ALTER EXTERNAL CONNECTIONS POOL CLEAR ALL</title>
            </info>

            <indexterm>
                <primary>ALTER EXTERNAL CONNECTIONS POOL</primary>
                <secondary>CLEAR ALL</secondary>
            </indexterm>

            <formalpara>
                <title>Назначение:</title>

                <para>Закрывает все бездействующие соединения.</para>
            </formalpara>

            <formalpara>
                <title>Синтаксис:</title>

                <para>
                    <literallayout class="monospaced">
ALTER EXTERNAL CONNECTIONS POOL CLEAR ALL                     
                        </literallayout>
                </para>
            </formalpara>

            <para>Оператор <code>ALTER EXTERNAL CONNECTIONS POOL CLEAR ALL</code> закрывает все
                бездействующие соединения в пуле внешних соединений. Все активные соединения будут
                отсоединены от пула (такие соединения будут немедленно закрыты, когда они не будут
                использоваться).</para>

        </section>

        <section xml:id="session-extconnpool-clearoldest">
            <info>
                <title>ALTER EXTERNAL CONNECTIONS POOL CLEAR OLDEST</title>
            </info>

            <indexterm>
                <primary>ALTER EXTERNAL CONNECTIONS POOL</primary>
                <secondary>CLEAR OLDEST</secondary>
            </indexterm>

            <formalpara>
                <title>Назначение:</title>

                <para>Закрывает бездействующие соединения у которых истекло время жизни.</para>
            </formalpara>

            <formalpara>
                <title>Синтаксис:</title>

                <para>
                    <literallayout class="monospaced">
ALTER EXTERNAL CONNECTIONS POOL CLEAR OLDEST                    
                        </literallayout>
                </para>
            </formalpara>

            <para>Оператор <code>ALTER EXTERNAL CONNECTIONS POOL CLEAR OLDEST</code> закрывает
                бездействующие соединения в пуле у которых истекло время жизни.</para>

        </section>
    </section>


    <section xml:id="session-role">
        <info>
            <title>Изменение текущей роли</title>
        </info>
        <section xml:id="session-role-setrole">
            <info>
                <title>SET ROLE</title>
                <keywordset>
                    <keyword>SET ROLE</keyword>
                </keywordset>
            </info>
            <indexterm><primary>SET ROLE</primary></indexterm>
            <formalpara>
                <title>Назначение:</title>

                <para>Изменение текущей роли.</para>
            </formalpara>

            <formalpara>
                <info>
                    <title>Доступно в:</title>
                </info>

                <para>DSQL.</para>
            </formalpara>
            <formalpara>
                <title>Синтаксис:</title>


                <para><programlisting>
SET ROLE <replaceable>rolename</replaceable>  
                       </programlisting></para>
            </formalpara>
            <para>
                <table frame="all">
                    <title>Параметры оператора SET ROLE</title>
                    <?dbfo keep-together='auto'?>
                    <tgroup cols="2">
                        <colspec colname="c1" colnum="1" colwidth="0.8*" align="left"/>
                        <colspec colname="c2" colnum="2" colwidth="2.0*" align="justify"/>
                        <thead>
                            <row>
                                <entry align="center">Параметр</entry>
                                <entry align="center">Описание</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry><replaceable>rolename</replaceable></entry>
                                <entry>
                                    <para>Имя устанавливаемой роли.</para>
                                </entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </para>

            <para>Согласно стандарту SQL-2008 оператор SET ROLE позволяет установить контекстной
                переменной CURRENT_ROLE одну из назначенных ролей для пользователя CURRENT_USER или
                роль, полученную в результате доверительной аутентификации (в этом случае оператор
                принимает вид SET TRUSTED ROLE).</para>

            <formalpara>
                <title>Примеры:</title>

                <para>
                    <example>
                        <title>Изменение текущей роли</title>
                        <para><programlisting language="sql">
SET ROLE manager;
select current_role from rdb$database;
              
                </programlisting>
                            <screen>
ROLE
=======================
MANAGER                    
                </screen>
                        </para>
                    </example>
                </para>
            </formalpara>
        </section>
        <section xml:id="session-role-settrustedrole">
            <info>
                <title>SET TRUSTED ROLE</title>
                <keywordset>
                    <keyword>SET TRUSTED ROLE</keyword>
                </keywordset>
            </info>
            <indexterm><primary>SET TRUSTED ROLE</primary></indexterm>
            <formalpara>
                <title>Назначение:</title>

                <para>Установка доверенной роли.</para>
            </formalpara>

            <formalpara>
                <title>Доступно в:</title>

                <para>DSQL.</para>
            </formalpara>
            <formalpara>
                <title>Синтаксис:</title>

                <para><programlisting>
SET TRUSTED ROLE 
                       </programlisting></para>
            </formalpara>

            <para>Оператор SET TRUSTED ROLE включает доступ доверенной роли, при условии, что
                CURRENT_USER получен с помощью доверительной аутентификации и роль доступна.</para>
            <para>Идея отдельной команды SET TRUSTED ROLE состоит в том, чтобы при подключении
                доверенного пользователя не указывать никакой дополнительной информации о роли, SET
                TRUSTED ROLE делает доверенную роль (если таковая существует) текущей ролью без
                дополнительной деятельности, связанной с установкой параметров DBP.</para>
            <para>Доверенная роль это не специальный тип роли, ей может быть любая роль, созданная с
                помощью оператора CREATE ROLE или предопределённая системная роль RDB$ADMIN. Она
                становится доверенной ролью для подключения, когда подсистема отображения объектов
                безопасности (security objects mapping subsystem) находит соответствие между
                результатом аутентификации, полученным от плагина и локальным или глобальным
                отображением (mapping) для текущей базы данных. Роль даже может быть той, которая не
                предоставлена явно этому доверенному пользователю. </para>
            <note>
                <para>Доверенная роль не назначается при подключении по умолчанию. Можно изменить
                    это поведение, используя соответствующий плагин аутентификации и команды
                    CREATE/ALTER MAPPING.</para>
            </note>
            <para>Примером использования доверенной роли является назначение системной роли
                RDB$ADMIN для администраторов Windows, когда используется доверительная
                аутентификация Windows.</para>
        </section>
    </section>

    <section xml:id="session-timezone">
        <info>
            <title>Управление часовым поясом и обработкой часовых поясов</title>
        </info>

        <section xml:id="session-timezone-settimezone">
            <info>
                <title>SET TIME ZONE</title>
            </info>
            <indexterm>
                <primary>SET TIME ZONE</primary>
            </indexterm>

            <formalpara>
                <title>Назначение:</title>

                <para>Изменение часового пояса сеанса.</para>
            </formalpara>
            <formalpara>
                <title>Синтаксис:</title>
                <para>
                    <literallayout class="monospaced">
SET TIME ZONE { <replaceable>&lt;time zone string&gt;</replaceable> | LOCAL }
                        
<replaceable>&lt;time zone string&gt;</replaceable> ::=
    '<replaceable>&lt;time zone&gt;</replaceable>'                            
                            
<replaceable>&lt;time zone&gt;</replaceable> ::=
    <replaceable>&lt;time zone region&gt;</replaceable> |
    [+/-] <replaceable>&lt;hour displacement&gt;</replaceable> [: <replaceable>&lt;minute displacement&gt;</replaceable>]                          
                        </literallayout>
                </para>
            </formalpara>

            <para>Немедленно изменяет часовой пояс сеанса (текущего подключения).</para>

            <formalpara>
                <title>Примеры:</title>

                <para>
                    <example>
                        <title>Изменение часового пояса</title>

                        <para><programlisting language="sql"> 
set time zone '-02:00';

set time zone 'America/Sao_Paulo';

set time zone local;
                </programlisting>
                        </para>
                    </example>
                </para>
            </formalpara>
            <formalpara>
                <title>См. также:</title>

                <para>
                    <link linkend="types-datetime-timezone">Часовой пояс</link>. </para>
            </formalpara>
        </section>

        <section xml:id="session-timezone-settimezonebind">
            <info>
                <title>SET TIME ZONE BIND</title>
            </info>
            <indexterm>
                <primary>SET TIME ZONE BIND</primary>
            </indexterm>

            <formalpara>
                <title>Назначение:</title>

                <para>Изменение привязки типов с WITH TIME ZONE</para>
            </formalpara>
            <formalpara>
                <title>Синтаксис:</title>
                <para>
                    <literallayout class="monospaced">
SET TIME ZONE BIND { NATIVE | LEGACY }                      
                        </literallayout>
                </para>
            </formalpara>

            <para>Оператор изменяет привязку часового пояса сеанса для совместимости со старыми
                клиентами.</para>

            <para>Значение по умолчанию - NATIVE, что означает, что выражения <code>TIME WITH TIME
                    ZONE</code> и <code>TIMESTAMP WITH TIME ZONE</code> возвращаются с новыми типами
                данных для клиента.</para>

            <para>Старые клиенты могут не понимать новые типы данных, поэтому можно определить
                привязку к LEGACY, и выражения будут возвращены как <code>TIME WITHOUT TIME
                    ZONE</code> и <code>TIMESTAMP WITHOUT TIME ZONE</code> с соответствующим
                преобразованием. </para>

            <para>Конфигурация привязки применима также к входным параметрам.</para>

            <formalpara>
                <title>Примеры:</title>

                <para>
                    <example>
                        <title>Изменение привзяки для типов времени и даты-времени</title>

                        <para><programlisting language="sql"> 
set time zone bind native;

set time zone bind legacy;
                </programlisting>
                        </para>
                    </example>
                </para>
            </formalpara>
        </section>
    </section>

    <section xml:id="session-decfloat">
        <info>
            <title>Управление обработкой DECFLOAT</title>
        </info>

        <section xml:id="session-decfloat-round">
            <info>
                <title>SET DECFLOAT ROUND</title>
            </info>
            <indexterm>
                <primary>SET DECFLOAT ROUND</primary>
            </indexterm>

            <formalpara>
                <title>Назначение:</title>

                <para>Изменение режима округления для типа DECFLOAT.</para>
            </formalpara>
            <formalpara>
                <title>Синтаксис:</title>
                <para>
                    <literallayout class="monospaced">
SET DECFLOAT ROUND <replaceable>&lt;mode&gt;</replaceable>                      
                        </literallayout>
                </para>
            </formalpara>
            <para>
                <table frame="all">
                    <?dbfo keep-together='auto'?>
                    <title>Параметры оператора SET DECFLOAT ROUND</title>
                    <tgroup cols="2">
                        <colspec colname="colArgument" colnum="1" colwidth="1.2*" align="left"/>
                        <colspec colname="colDesc" colnum="2" colwidth="2.8*" align="justify"/>
                        <thead>
                            <row valign="middle">
                                <entry align="center">Параметр</entry>
                                <entry align="center">Описание</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry><replaceable>mode</replaceable></entry>
                                <entry>
                                    <para>Режим округления.</para>
                                </entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </para>
            <para>Оператор SET DECFLOAT ROUND изменяет режим округления для текущей сессии.
                Поддерживаются следующие режимы округления совместимые со стандартом IEEE: <itemizedlist>
                    <listitem>
                        <para><emphasis role="bold">CEILING</emphasis>. Округление сверху. Если все
                            отбрасываемые цифры равны нулю или знак числа отрицателен, последняя
                            неотбрасываемая цифра не меняется. В противном случае последняя
                            неотбрасываемая цифра инкрементируется на единицу (округляется в большую
                            сторону).</para>
                    </listitem>
                    <listitem>
                        <para><emphasis role="bold">UP</emphasis>. Округление по направлению от нуля
                            (усечение с приращением). Отбрасываемые значения игнорируются.</para>
                    </listitem>
                    <listitem>
                        <para><emphasis role="bold">HALF_UP</emphasis>. Округление к ближайшему
                            значению. Если результат равноудаленный, выполняется округление в
                            большую сторону. Если отбрасываемые значения больше чем или равны
                            половине (0.5) единицы в следующей левой позиции, последняя
                            неотбрасываемая цифра инкрементируется на единицу (округляется в большую
                            сторону). В противном случае отбрасываемые значения игнорируются. Этот
                            режим округления используется в Firebird по умолчанию.</para>
                    </listitem>
                    <listitem>
                        <para><emphasis role="bold">HALF_EVEN</emphasis>. Округление к ближайшему
                            значению. Если результат равноудаленный, выполняется округление так,
                            чтобы последняя цифра была четной. Если отбрасываемые значения больше
                            половины (0.5) единицы в следующей левой позиции, последняя
                            неотбрасываемая цифра инкрементируется на единицу (округляется в большую
                            сторону). Если они меньше половины, результат не корректируется (то есть
                            отбрасываемые знаки игнорируются). В противном случае, когда
                            отбрасываемые значения точно равны половине, последняя неотбрасываемая
                            цифра не меняется, если она является четной и инкрементируется на
                            единицу (округляется в большую сторону) в противном случае (чтобы
                            получить четную цифру). Этот режим округления называется также
                            банковским округлением и дает ощущение справедливого округления.</para>
                    </listitem>
                    <listitem>
                        <para><emphasis role="bold">HALF_DOWN</emphasis>. Округление к ближайшему
                            значению. Если результат равноудаленный, выполняется округление в
                            меньшую сторону. Если отбрасываемые значения больше чем или равны
                            половине (0.5) единицы в следующей левой позиции, последняя
                            неотбрасываемая цифра декрементируется на единицу (округляется в меньшую
                            сторону). В противном случае отбрасываемые значения игнорируются.</para>
                    </listitem>
                    <listitem>
                        <para><emphasis role="bold">DOWN</emphasis>. Округление по направлению к
                            нулю (усечение). Отбрасываемые значения игнорируются.</para>
                    </listitem>
                    <listitem>
                        <para><emphasis role="bold">FLOOR</emphasis>. Округление снизу. Если все
                            отбрасываемые цифры равны нулю или знак положителен, последняя
                            неотбрасываемая цифра не меняется. В противном случае (знак отрицателен)
                            последняя неотбрасываемая цифра инкрементируется на единицу.</para>
                    </listitem>
                    <listitem>
                        <para><emphasis role="bold">REROUND</emphasis>. Округление к большему
                            значению, если округляется 0 или 5, в противном случае округление
                            происходит к меньшему значению.</para>
                    </listitem>
                </itemizedlist></para>

            <formalpara>
                <title>Примеры:</title>

                <para>
                    <example>
                        <title>Изменение режима округления</title>

                        <para><programlisting language="sql"> 
SET DECFLOAT ROUND HALF_DOWN;
                </programlisting>
                        </para>
                    </example>
                </para>
            </formalpara>

            <para>Подробнее о режимах округления лдя типа DECFLOAT см. <link
                    linkend="types-float-decfloat-round-mode">Режимы округления</link>.</para>
        </section>

        <section xml:id="session-decfloat-traps">
            <info>
                <title>SET DECFLOAT TRAPS TO</title>
            </info>
            <indexterm>
                <primary>SET DECFLOAT TRAPS TO</primary>
            </indexterm>

            <formalpara>
                <title>Назначение:</title>

                <para>Изменение обработки ошибок для типа DECFLOAT.</para>
            </formalpara>
            <formalpara>
                <title>Синтаксис:</title>
                <para>
                    <literallayout class="monospaced">
SET DECFLOAT TRAPS TO <replaceable>&lt;traps list&gt;</replaceable>      
                            
<replaceable>&lt;traps list&gt;</replaceable> ::= <replaceable>&lt;trap&gt;</replaceable>[, <replaceable>&lt;trap&gt;</replaceable>[, ... <replaceable>&lt;trap&gt;</replaceable>]]        
                            
<replaceable>&lt;trap&gt;</replaceable> ::= 
    Division_by_zero 
  | Inexact
  | Invalid_operation
  | Overflow 
  | Underflow                           
                        </literallayout>
                </para>
            </formalpara>

            <para>По умолчанию исключения генерируется для следующих ситуаций: Division_by_zero,
                Invalid_operation, Overflow, Underflow.</para>
            <example>
                <title>Установка ситуаций для которых будет генерироваться исключение</title>

                <para>
                    <programlisting language="sql"> 
SET DECFLOAT TRAPS TO Division_by_zero, Inexact, Invalid_operation, Overflow, Underflow;
                </programlisting>
                </para>
            </example>
        </section>

        <section xml:id="session-decfloat-bind">
            <info>
                <title>SET DECFLOAT BIND</title>
            </info>
            <indexterm>
                <primary>SET DECFLOAT BIND</primary>
            </indexterm>

            <formalpara>
                <title>Назначение:</title>

                <para>Измененение отображения значений DECFLOAT на другие доступные типы
                    данных.</para>
            </formalpara>
            <formalpara>
                <title>Синтаксис:</title>
                <para>
                    <literallayout class="monospaced">
SET DECFLOAT BIND <replaceable>&lt;bind-type&gt;</replaceable>      
                            
<replaceable>&lt;bind-type&gt;</replaceable> ::= 
    NATIVE 
  | CHAR[ACTER]
  | DOUBLE PRECISION
  | BIGINT[, <replaceable>scale</replaceable>]                          
                        </literallayout>
                </para>
            </formalpara>
            <para>
                <table frame="all">
                    <?dbfo keep-together='auto'?>
                    <title>Параметры оператора SET DECFLOAT BIND</title>
                    <tgroup cols="2">
                        <colspec colname="c1" colnum="1" colwidth="1.2*" align="left"/>
                        <colspec colname="c2" colnum="2" colwidth="2.8*" align="justify"/>
                        <thead>
                            <row>
                                <entry align="center">Параметр</entry>
                                <entry align="center">Описание</entry>
                            </row>
                        </thead>
                        <tbody>
                            <row>
                                <entry><para><replaceable>scale</replaceable></para></entry>
                                <entry>
                                    <para>Точность (количество знаков после запятой).</para>
                                </entry>
                            </row>
                        </tbody>
                    </tgroup>
                </table>
            </para>
            <para>Оператор SET DECFLOAT BIND управляет каким образом значения типа DEСFLOAT будут
                представлены во внешнем мире. Допустимые типы для привязки: <itemizedlist>
                    <listitem>
                        <para>NATIVE — используется IEEE754 двоичное представление;</para>
                    </listitem>
                    <listitem>
                        <para>CHAR[ACTER] — ASCII строка;</para>
                    </listitem>
                    <listitem>
                        <para>DOUBLE PRECISION — используется 8 байтное представление с плавающей
                            точкой, тоже самое что и для полей типа DOUBLE PRECISION;</para>
                    </listitem>
                    <listitem>
                        <para>BIGINT — используется целое с указанным масштабом, тоже самое что поле
                            NUMERIC(18, <replaceable>scale</replaceable>).</para>
                    </listitem>
                </itemizedlist></para>
            <para>Различные привязки полезны, если вы планируете использовать значения DECFLOAT со
                старым клиентом, не поддерживающим собственный формат. Можно выбирать между строками
                (идеальная точность, но плохая поддержка для дальнейшей обработки), значения с
                плавающей запятой (идеальная поддержка для дальнейшей обработки, но с плохой
                точностью) или масштабированные целые числа (хорошая поддержка дальнейшей обработки
                и требуемая точность, но диапазон значений очень ограничен). Когда используется
                инструмент, подобный универсальному GUI-клиенту, выбор привязки к CHAR подходит в
                большинстве случаев.</para>
        </section>

    </section>

    <section xml:id="session-resetsession">
        <info>
            <title>ALTER SESSION RESET</title>
            <keywordset>
                <keyword>ALTER SESSION RESET</keyword>
            </keywordset>
        </info>
        <indexterm><primary>ALTER SESSION RESET</primary></indexterm>

        <formalpara>
            <title>Назначение:</title>

            <para>Сброс сессионого окружения.</para>
        </formalpara>

        <formalpara>
            <title>Доступно в:</title>

            <para>DSQL.</para>
        </formalpara>

        <formalpara>
            <title>Синтаксис:</title>

            <para><literallayout class="monospaced">                                       
ALTER SESSION RESET      
            </literallayout></para>
        </formalpara>

        <para>Сбрасывает сеансовое окружение (подключения) к исходному состоянию. Эта
            функциональность полезна если сеанс используется повторно, вместо того чтобы производить
            отключение/подключение.</para>

        <para>Данный оператор делает следующее: <itemizedlist>
                <listitem>
                    <para>сбрасывает установленные параметры DECFLOAT (BIND, TRAP и ROUND) в
                        значения по умолчанию;</para>
                </listitem>
                <listitem>
                    <para>сбрасывает тайм-ауты сессии и оператора в 0;</para>
                </listitem>
                <listitem>
                    <para>удаляет все контекстные переменные из пространства имён
                        USER_SESSION;</para>
                </listitem>
                <listitem>
                    <para>очищает содержимое всех используемых глобальных таблиц уровня соединения
                        (COMMIT PRESERVE ROWS);</para>
                </listitem>
                <listitem>
                    <para>сбрасывает роль в значение переданное в DPB (указанное при подключении) и
                        очищает кеш привелегий (если роль была изменена с помощью оператора SET
                        ROLE);</para>
                </listitem>
                <listitem>
                    <para>текущая активная транзакция откатывается и стартуется новая с теми же
                        параметрами, после рестарта.</para>
                </listitem>
            </itemizedlist></para>
        <warning>
            <para>
                <itemizedlist>
                    <listitem>
                        <para>Если в текущей активной транзакции были произведены изменения, то
                            будет выдано предупреждение.</para>
                    </listitem>
                    <listitem>
                        <para>Если в текущей сессии активны другие транзакции, то будет выдана
                            ошибка. При проверке транзакций перед сбросом сессии подготовленные 2PC
                            транзакции игнорируются.</para>
                    </listitem>
                </itemizedlist>
            </para>
        </warning>
    </section>

</chapter>
